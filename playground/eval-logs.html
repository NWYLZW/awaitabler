<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eval Logs</title>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="module">
    import awaitAutoBox from 'awaitabler/await-auto-box'
    Babel.registerPlugin('await-auto-box', awaitAutoBox)
  </script>
  <script type="module">
    import Awaitabler from 'awaitabler'
    window.require = function (name) {
      switch (name) { case 'awaitabler': return Awaitabler }
      throw new Error(`Cannot find module '${name}'`)
    }
  </script>
  <script>
    /** @type {Function} */
    let prevDisposeFunc
    window.addEventListener('message', e => {
      switch (e.data.type) {
        case 'run': {
          const { code, lang } = e.data
          /** @type {string} */
          let runCode
          switch (lang) {
            case 'javascript': {
              const { code: transformCode } = Babel.transform(code, {
                presets: ['es2015'],
                plugins: ['await-auto-box']
              })
              runCode = transformCode
              break
            }
          }
          try {
            const getExportsRunCode = `
(function () {
  const module = { exports: {} };
  const exports = module.exports;
  ${runCode};
  return module.exports
})()`.trim()
            prevDisposeFunc?.()
            const { dispose } = eval(getExportsRunCode)
            prevDisposeFunc = dispose
          } catch (e) {
            console.error(e)
          }
          break
        }
        case 'update:localStorage': {
          const { key, data } = e.data
          localStorage.setItem(key, JSON.stringify(data))
        }
      }
    })
    localStorage.setItem('chii-embedded-height', 10000)
    localStorage.setItem('panel-selectedTab', '"console"')
    localStorage.setItem('textEditorIndent', '"  "')
  </script>
  <script src="/target.js" embedded="true"></script>
  <style type="text/css">
    html, body { margin: 0; padding: 0; }
  </style>
</head>
<body>
</body>
</html>
